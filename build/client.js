var FancySupport={node_message:null,node_chat:null,node_listings:null,current:null,conversations:[],url:"http://api.fancysupport.com:4000",build_query_string:function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&void 0!==e[n]&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")},init:function(){function e(){var e={"&":"&#38;","<":"&#60;",">":"&#62;",'"':"&#34;","'":"&#39;","/":"&#47;"},t=/&(?!#?\w+;)|<|>|"|'|\//g;return function(){return this?this.replace(t,function(t){return e[t]||t}):this}}var t=this;this.impression(),this.get_messages(),document.querySelector(FancyUser.activator).addEventListener("click",function(){t.renderWidget(),t.renderChat()}),String.prototype.encodeHTML=e()},impression:function(){if(!FancyUser)throw"Fancy needs a FancyUser object to run.";if(!FancyUser.signature)throw"FancyUser needs a customer signature field: signature";if(!FancyUser.app_key)throw"FancyUser needs an application key field: app_key.";if(!FancyUser.customer_id)throw"FancyUser needs a customer id field: customer_id.";var e=this.build_query_string({signature:FancyUser.signature,app_key:FancyUser.app_key,customer_id:FancyUser.customer_id,name:FancyUser.name,email:FancyUser.email,phone:FancyUser.phone});this.ajax({method:"POST",url:"/impression",data:e})},onSendClick:function(){var e=this,t=this.node_message.value;if(this.node_message.value="",""!==t){var n=this.build_query_string({app_key:FancyUser.app_key,signature:FancyUser.signature,customer_id:FancyUser.customer_id}),a={content:t,customer_id:FancyUser.customer_id};this.current?this.ajax({method:"POST",url:"/messages/"+this.current.id+"/reply?"+n,data:a,json:!0},function(t,n){console.log(t,n),t&&(a.incoming=!0,e.current.replies.push(a),e.renderMessages(e.current))}):this.ajax({method:"POST",url:"/messages?"+n,data:a,json:!0},function(t,n){console.log(t,n),t&&(t.data.replies=[],e.current=t.data,e.conversations.push(e.current),e.renderMessages(e.current))})}},onChatsClick:function(){this.renderListings(),this.renderHeader({title:"previous chats",which:"new"}),this.current=null;for(var e=this,t=function(){var t=this.getAttribute("data-id");e.current=e.conversations[t],e.renderChat(),e.renderMessages(e.current)},n=document.querySelectorAll(".listing"),a=0;a<n.length;a++)n[a].addEventListener("click",t)},renderWidget:function(){var e=document.getElementById("fancy-chat");e||(e=document.createElement("div"),e.id="fancy-chat",document.body.appendChild(e)),e.innerHTML=this.templates.widget(),this.node_chat=document.querySelector("#fancy-chat .chat"),this.node_listings=document.querySelector("#fancy-chat .listings")},renderHeader:function(e){var t=this,n=document.querySelector("#fancy-chat .header");n.innerHTML=this.templates.header(e);var a=document.getElementById("fancy-close"),i=document.getElementById("fancy-newchats"),s=function(){t.onChatsClick()},c=function(){t.current=null,t.renderChat()};i.addEventListener("click","new"==e.which?c:s),a.addEventListener("click",function(){t.removeWidget()})},renderChat:function(){var e=this;this.renderHeader({title:"new chat",which:"chats"}),this.node_chat.innerHTML=this.templates.chat(),this.node_listings.innerHTML="";var t=document.getElementById("fancy-send");this.node_message=document.getElementById("fancy-message"),this.messages=document.getElementById("fancy-messages"),t.addEventListener("click",function(){e.onSendClick()})},renderListings:function(){this.node_listings.innerHTML=this.templates.listings(this.conversations),this.node_chat.innerHTML=""},renderMessages:function(e){this.renderHeader({title:"existing chat",which:"chats"});var t=document.getElementById("fancy-messages");t.innerHTML=this.templates.messages(e),t.scrollTop=t.scrollHeight},removeWidget:function(){document.body.removeChild(document.getElementById("fancy-chat")),this.messages=null,this.node_message=null,this.current=null},ajax:function(e,t){var n=function(e){var t;try{t=JSON.parse(e.responseText)}catch(n){t=e.responseText}return[t,e]},a=function(e,t,a,i){var s={success:function(){},error:function(){}},c=XMLHttpRequest||ActiveXObject,r=new c("MSXML2.XMLHTTP.3.0");r.open(e,t,!0),i?(r.setRequestHeader("Content-type","application/json"),a=JSON.stringify(a)):r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.onreadystatechange=function(){4===r.readyState&&(r.status>=200&&r.status<300?s.success.apply(s,n(r)):s.error.apply(s,n(r)))},r.send(a);var d={success:function(e){return s.success=e,d},error:function(e){return s.error=e,d}};return d};ajax={},ajax.GET=function(e){return a("GET",e)},ajax.PUT=function(e,t,n){return a("PUT",e,t,n)},ajax.POST=function(e,t,n){return a("POST",e,t,n)},ajax.DELETE=function(e){return a("DELETE",e)};var i=function(e,n){t&&t({code:n.status,data:e})};ajax[e.method](this.url+e.url,e.data,e.json).success(i).error(i)},get_messages:function(){var e=this,t=this.build_query_string({app_key:FancyUser.app_key,signature:FancyUser.signature,customer_id:FancyUser.customer_id});this.ajax({method:"GET",url:"/messages?"+t},function(t){t&&(e.conversations=t.data)})}};FancySupport.init(),function(e,t){var n=e.createElement("style");if(e.getElementsByTagName("head")[0].appendChild(n),n.styleSheet)n.styleSheet.disabled||(n.styleSheet.cssText=t);else try{n.innerHTML=t}catch(a){n.innerText=t}}(document,"#fancy-chat{position:fixed;left:50%;top:50%;width:650px;margin-left:-325px;height:450px;margin-top:-225px;z-index:1234;box-shadow:0 0 0 1px #000;}#fancy-chat *{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;margin:0;padding:0}#fancy-chat.hide{display:none}#fancy-chat.block{display:block}#fancy-chat .header{height:80px;box-shadow:0 0 0 1px #000;background-color:#eaeaea;}#fancy-chat .header span{position:absolute;width:550px;top:25px;left:50px;font-size:18pt;text-align:center}#fancy-chat .header a{position:absolute;right:32px;top:31px;width:25px;height:25px;cursor:pointer;text-align:center;}#fancy-chat .header a#fancy-close{right:5px}#fancy-chat #fancy-messages{margin-top:1px;height:250px;box-shadow:0 0 0 1px #000;overflow-y:auto;}#fancy-chat #fancy-messages .message{overflow:hidden;margin:0}#fancy-chat #fancy-messages .in{background-color:#ebebeb;}#fancy-chat #fancy-messages .in .message{padding-left:10px}#fancy-chat #fancy-messages .out .message{text-align:right;padding-right:10px}#fancy-chat .send{position:relative;height:120px;}#fancy-chat .send #fancy-send{position:absolute;right:8px;top:8px;width:13%;height:104px;line-height:104px;cursor:pointer;display:inline-block;text-align:center;outline:none;border:none;background-color:#d6d6d6;color:#808080;-webkit-border-radius:.25em;-moz-border-radius:.25em;border-radius:.25em;-webkit-user-select:none;-moz-user-select:none;user-select:none}#fancy-chat .send .message{width:550px;margin:0;padding-top:8px;padding-left:8px;}#fancy-chat .send .message textarea{width:100%;height:104px;resize:none;padding:.6em 1em;line-height:1.33;vertical-align:top;outline:none;-webkit-border-radius:.3125em;-moz-border-radius:.3125em;border-radius:.3125em}\n@media only screen and (max-width:1030px) and (orientation:landscape){#fancy-chat{width:650px;margin-left:-325px;height:385px;margin-top:-192.5px;}#fancy-chat .header{height:60px;}#fancy-chat .header span{top:14px}#fancy-chat .header a{top:21px}#fancy-chat #fancy-messages{height:210px}#fancy-chat .send #fancy-send{height:100px}#fancy-chat .send .message textarea{height:100px}}@media only screen and (max-width:600px) and (orientation:portrait){#fancy-chat{width:590px;margin-left:-295px;height:450px;margin-top:-225px;}#fancy-chat .header span{width:384px;left:103px}#fancy-chat .send .message{width:496px}}@media only screen and (max-width:600px) and (orientation:landscape){#fancy-chat{width:590px;margin-left:-295px;height:350px;margin-top:-175px;}#fancy-chat .header{height:60px;}#fancy-chat .header span{width:384px;left:103px;top:14px}#fancy-chat .header a{top:21px}#fancy-chat #fancy-messages{height:170px}#fancy-chat .send .message{width:496px}}@media only screen and (max-width:568px) and (orientation:landscape){#fancy-chat{width:560px;margin-left:-280px;height:250px;margin-top:-125px;}#fancy-chat .header{height:60px;}#fancy-chat .header span{width:366px;left:97px;top:14px}#fancy-chat .header a{top:21px}#fancy-chat #fancy-messages{height:100px}#fancy-chat .send{height:85px;}#fancy-chat .send #fancy-send{right:5px;top:5px;width:75px;height:80px;line-height:80px}#fancy-chat .send .message{width:474px;padding-left:5px;padding-top:5px;}#fancy-chat .send .message textarea{height:80px}}@media only screen and (max-width:480px) and (orientation:landscape){#fancy-chat{width:460px;margin-left:-230px;height:250px;margin-top:-125px;}#fancy-chat .header{height:60px;}#fancy-chat .header span{width:300px;left:80px;top:14px}#fancy-chat .header a{top:21px}#fancy-chat #fancy-messages{height:100px}#fancy-chat .send{height:85px;}#fancy-chat .send #fancy-send{right:5px;top:5px;width:75px;height:80px;line-height:80px}#fancy-chat .send .message{width:375px;padding-left:5px;padding-top:5px;}#fancy-chat .send .message textarea{height:80px}}@media only screen and (max-width:384px) and (min-width:321px){#fancy-chat{width:375px;margin-left:-187.5px;height:590px;margin-top:-295px;}#fancy-chat .header span{width:250px;left:67px}#fancy-chat #fancy-messages{height:395px}#fancy-chat .send #fancy-send{right:5px;top:5px;width:65px}#fancy-chat .send .message{width:300px;padding-left:5px;padding-top:5px}}@media only screen and (max-width:320px){#fancy-chat{width:310px;margin-left:-155px;height:400px;margin-top:-200px;}#fancy-chat .header{height:60px;}#fancy-chat .header span{width:200px;left:55px;top:14px}#fancy-chat .header a{top:21px}#fancy-chat .send{height:85px;}#fancy-chat .send #fancy-send{right:5px;top:5px;width:50px;height:80px;line-height:80px}#fancy-chat .send .message{width:250px;padding-left:5px;padding-top:5px;}#fancy-chat .send .message textarea{height:80px}}"),FancySupport.templates={},FancySupport.templates.chat=function(){var e='<div id="fancy-messages"></div><div class="send"><div class="message"><textarea id="fancy-message" placeholder="batman"></textarea></div><div id="fancy-send">Send</div></div>';return e},FancySupport.templates.header=function(e){var t="<span>"+e.title+'</span><a id="fancy-newchats">'+e.which+'</a><a id="fancy-close">X</a>';return t},FancySupport.templates.listings=function(e){var t='<div id="fancy-listings">',n=e;if(n)for(var a,i=-1,s=n.length-1;s>i;)a=n[i+=1],t+='<div class="listing" data-id="'+i+'">'+(a.content||"").toString().encodeHTML()+"</div>";return t+="</div>"},FancySupport.templates.messages=function(e){var t="",n=e.incoming;t+='<div class="',t+=e.incoming===!0?"in":"out",t+='"><p class="message">'+(e.content||"").toString().encodeHTML()+"</p>";var a=e.replies;if(a)for(var i,s=-1,c=a.length-1;c>s;)i=a[s+=1],i.incoming===n?t+='<p class="message">'+(i.content||"").toString().encodeHTML()+"</p>":(t+='</div><div class="',t+=i.incoming===!0?"in":"out",t+='"><p class="message">'+(i.content||"").toString().encodeHTML()+"</p>"),n=i.incoming;return t+="</div>"},FancySupport.templates.widget=function(){var e='<div class="header"></div><div class="body"><div class="chat"></div><div class="listings"></div></div>';return e};